
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Dashboard - St. Mary's High School</title>
  <!-- Favicon -->
  <link rel="icon" href="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" type="image/jpeg" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF and autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <style>
    :root {
      --primary: #1a365d;
      --secondary: #d69e2e;
      --accent: #9f7aea;
      --glass: rgba(26, 54, 93, 0.15);
      --bg-gradient: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      --text-color: #ffffff;
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      --header-height: 80px;
    }
    [data-theme="light"] {
      --primary: #3182ce;
      --secondary: #dd6b20;
      --accent: #805ad5;
      --glass: rgba(237, 242, 247, 0.9);
      --bg-gradient: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
      --text-color: #2d3748;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }
    body {
      background: var(--bg-gradient);
      color: var(--text-color);
      min-height: 100vh;
      transition: all 0.6s ease;
      line-height: 1.6;
    }
    /* Enhanced Header */
    header {
      background: rgba(26, 54, 93, 0.9);
      backdrop-filter: blur(12px);
      padding: 0 5%;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: var(--card-shadow);
      border-bottom: 2px solid var(--secondary);
    }
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      color: white;
    }
    .logo span {
      color: var(--secondary);
    }
    .header-logo {
      height: 50px;
      margin-right: 15px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .hamburger-btn {
      font-size: 1.8rem;
      cursor: pointer;
      background: transparent;
      border: none;
      color: white;
      transition: transform 0.3s ease;
    }
    .hamburger-btn:hover {
      transform: scale(1.1);
      color: var(--secondary);
    }
    /* Enhanced Side Menu */
    #sideMenu {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: 280px;
      height: calc(100vh - var(--header-height));
      background: rgba(26, 54, 93, 0.95);
      backdrop-filter: blur(20px);
      padding: 2rem;
      transition: transform 0.4s ease;
      z-index: 999;
      box-shadow: 2px 0 15px rgba(0,0,0,0.1);
      border-right: 1px solid rgba(214, 158, 46, 0.3);
      overflow-y: auto;
    }
    @media (max-width: 767px) {
      #sideMenu {
        transform: translateX(-100%);
        width: 85vw;
      }
      #sideMenu.shown {
        transform: translateX(0);
      }
    }
    #sideMenu h2 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    #totalsDisplay {
      margin-bottom: 2rem;
    }
    #totalsDisplay p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: white;
    }
    #formTotals {
      list-style: none;
    }
    #formTotals li {
      margin-bottom: 1rem;
      color: white;
    }
    #formTotals li strong {
      color: var(--secondary);
    }
    #formTotals ul {
      list-style: none;
      margin-top: 5px;
      padding-left: 15px;
    }
    #formTotals ul li {
      margin-bottom: 3px;
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
    }
    /* Main Content */
    .main-container {
      padding: calc(var(--header-height) + 40px) 5% 120px;
      max-width: 1200px;
      margin: 0 auto;
      transition: margin-left 0.4s ease;
    }
    @media (min-width: 768px) {
      .main-container {
        margin-left: 280px;
      }
    }
    /* Guidance Section */
    #guidance {
      display: flex;
      align-items: flex-start;
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .guidance-favicon {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    #guidance p {
      color: white;
      font-size: 0.95rem;
    }
    #guidance p strong {
      color: var(--secondary);
    }
    /* Search and Filters */
    #searchStudent {
      width: 100%;
      padding: 0.9rem 1.2rem;
      margin-bottom: 1.5rem;
      border: none;
      border-radius: 8px;
      background: var(--glass);
      color: var(--text-color);
      font-size: 1rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }
    #searchStudent:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
    }
    #filterSection {
      margin-bottom: 2rem;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    #filterSection select {
      padding: 0.8rem 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: var(--glass);
      color: var(--text-color);
      font-size: 0.95rem;
      min-width: 180px;
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
    }
    #filterSection select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
    }
    /* Marks Entry Form */
    #marksForm {
      display: none;
      background: var(--glass);
      padding: 2rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }
    #marksForm h2 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }
    #marksForm h2 span {
      color: white;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 500;
      color: var(--secondary);
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--glass);
      color: var(--text-color);
      outline: none;
      transition: all 0.3s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
    }
    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }
    .form-group button {
      padding: 0.9rem 1.8rem;
      background: var(--secondary);
      color: #1a365d;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 15px;
    }
    .form-group button:hover {
      background: #e69c2a;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 2rem;
    }
    /* Report Card */
    #reportCard {
      background: var(--glass);
      padding: 2rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      display: none;
    }
    .report-header {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 1.5rem;
    }
    .report-header p {
      color: white;
      font-size: 0.95rem;
    }
    .report-header p span {
      color: var(--secondary);
      font-weight: 500;
    }
    #reportCard h3 {
      color: var(--secondary);
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }
    #reportCard table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
      background: rgba(255,255,255,0.05);
    }
    #reportCard th,
    #reportCard td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    #reportCard th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    #reportCard tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }
    #reportCard tr:hover {
      background: rgba(214, 158, 46, 0.1);
    }
    .pdf-btn {
      padding: 0.9rem 1.8rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 2rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pdf-btn:hover {
      background: #2c5282;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .pdf-btn i {
      font-size: 1.1rem;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      margin-top: 2rem;
    }
    /* Student List */
    .student-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }
    .student-card {
      background: var(--glass);
      padding: 1.5rem;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: var(--card-shadow);
    }
    .student-card:hover {
      transform: translateY(-5px);
      background: rgba(214, 158, 46, 0.1);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .student-card h3 {
      color: var(--secondary);
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .student-card p {
      color: white;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    /* Footer */
    footer {
      background: rgba(26, 54, 93, 0.9);
      color: white;
      padding: 1.5rem 5%;
      text-align: center;
      position: fixed;
      width: 100%;
      bottom: 0;
      z-index: 100;
      border-top: 1px solid rgba(214, 158, 46, 0.3);
    }
    footer p {
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    .social-icons {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .social-icons a {
      color: white;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }
    .social-icons a:hover {
      color: var(--secondary);
      transform: translateY(-3px);
    }
    /* Theme Toggle Button */
    #themeToggleButton {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      backdrop-filter: blur(8px);
      border: 2px solid var(--secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #themeToggleButton:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    #themeToggleButton i {
      font-size: 1.6rem;
      color: var(--secondary);
    }
    /* Responsive Adjustments */
    @media (max-width: 767px) {
      .main-container {
        padding: calc(var(--header-height) + 20px) 3% 120px;
      }
      #guidance {
        flex-direction: column;
      }
      .guidance-favicon {
        margin-bottom: 15px;
      }
      #filterSection {
        flex-direction: column;
        align-items: stretch;
      }
      #filterSection select {
        width: 100%;
      }
      .form-actions {
        flex-direction: column;
      }
      .form-group button {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
      }
    }
/* Style for action buttons in the table */
.edit-btn, .delete-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s ease;
  margin-right: 5px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.edit-btn {
  background-color: rgba(214, 158, 46, 0.2);
  color: var(--secondary);
}

.delete-btn {
  background-color: rgba(255, 99, 71, 0.2);
  color: #ff6347;
}

.edit-btn:hover {
  background-color: rgba(214, 158, 46, 0.3);
  transform: translateY(-1px);
}

.delete-btn:hover {
  background-color: rgba(255, 99, 71, 0.3);
  transform: translateY(-1px);
}

/* Style for form action buttons */
.form-actions button {
  padding: 0.9rem 1.8rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 2px solid transparent;
}

.form-actions button:first-child {
  background-color: var(--secondary);
  color: #1a365d;
}

.form-actions button:first-child:hover {
  background-color: #e69c2a;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.form-actions button:last-child {
  background-color: transparent;
  color: white;
  border-color: rgba(255,255,255,0.3);
}

.form-actions button:last-child:hover {
  background-color: rgba(255,255,255,0.1);
  border-color: rgba(255,255,255,0.5);
  transform: translateY(-2px);
}

/* Button animations when clicked */
button:active {
  transform: translateY(1px) !important;
}

/* Responsive adjustments */
@media (max-width: 767px) {
  .main-container {
    padding: calc(var(--header-height) + 20px) 3% 120px;
  }
  #guidance {
    flex-direction: column;
  }
  .guidance-favicon {
    margin-bottom: 15px;
  }
  #filterSection {
    flex-direction: column;
    align-items: stretch;
  }
  #filterSection select {
    width: 100%;
  }
  .form-actions {
    flex-direction: column;
  }
  .form-group button {
    width: 100%;
    margin-right: 0;
    margin-bottom: 10px;
  }
  
  /* Mobile-specific button adjustments */
  .edit-btn, .delete-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
  }
  
  .form-actions button {
    width: 100%;
    justify-content: center;
  }
}

/* Enhanced Fee Management Styles */
.fee-management-section {
  background: var(--glass);
  padding: 2rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: var(--card-shadow);
  border: 1px solid rgba(255,255,255,0.1);
}

.fee-management-section h2 {
  color: var(--secondary);
  margin-bottom: 1.5rem;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.fee-management-section h2 i {
  font-size: 1.3rem;
}

.fee-tabs {
  display: flex;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  margin-bottom: 1.5rem;
}

.fee-tab {
  padding: 0.8rem 1.5rem;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
  font-weight: 500;
}

.fee-tab.active {
  border-bottom-color: var(--secondary);
  color: var(--secondary);
}

.fee-tab:hover:not(.active) {
  background: rgba(255,255,255,0.05);
}

.fee-tab-content {
  display: none;
}

.fee-tab-content.active {
  display: block;
}

.fee-form {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 2rem;
}

.fee-form-group {
  margin-bottom: 1rem;
}

.fee-form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--secondary);
}

.fee-form-group input,
.fee-form-group select {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  background: var(--glass);
  color: var(--text-color);
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.fee-form-group input:focus,
.fee-form-group select:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
}

.fee-form-actions {
  display: flex;
  gap: 15px;
  margin-top: 1.5rem;
}

.fee-form-actions button {
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.fee-form-actions button:first-child {
  background-color: var(--secondary);
  color: #1a365d;
}

.fee-form-actions button:first-child:hover {
  background-color: #e69c2a;
  transform: translateY(-2px);
}

.fee-form-actions button:last-child {
  background-color: transparent;
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
}

.fee-form-actions button:last-child:hover {
  background-color: rgba(255,255,255,0.1);
  border-color: rgba(255,255,255,0.5);
}

/* Fee Summary Cards */
.fee-summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 2rem;
}

.fee-summary-card {
  background: var(--glass);
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.3s ease;
}

.fee-summary-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}

.fee-summary-card h3 {
  color: var(--secondary);
  margin-bottom: 1rem;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.fee-summary-card h3 i {
  font-size: 1.2rem;
}

.fee-summary-card p {
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.fee-summary-card small {
  font-size: 0.85rem;
  opacity: 0.8;
}

.fee-summary-card.paid {
  border-bottom: 4px solid #4ade80;
}

.fee-summary-card.unpaid {
  border-bottom: 4px solid #f87171;
}

.fee-summary-card.partial {
  border-bottom: 4px solid #fbbf24;
}

.fee-summary-card.total {
  border-bottom: 4px solid var(--accent);
}

/* DataTable Customization */
.dataTables_wrapper {
  margin-top: 1.5rem;
}

.dataTables_wrapper .dataTables_filter input {
  background: var(--glass);
  border: 1px solid rgba(255,255,255,0.3);
  color: var(--text-color);
  padding: 0.5rem;
  border-radius: 6px;
  margin-left: 10px;
}

.dataTables_wrapper .dataTables_length select {
  background: var(--glass);
  border: 1px solid rgba(255,255,255,0.3);
  color: var(--text-color);
  padding: 0.3rem;
  border-radius: 6px;
}

.dataTables_wrapper .dataTables_info,
.dataTables_wrapper .dataTables_paginate .paginate_button {
  color: var(--text-color) !important;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current,
.dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
  background: var(--secondary) !important;
  color: #1a365d !important;
  border: none !important;
}

.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
  background: rgba(255,255,255,0.1) !important;
  border: none !important;
}

/* Status Badges */
.status-badge {
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  display: inline-block;
}

.status-badge.paid {
  background-color: rgba(74, 222, 128, 0.2);
  color: #4ade80;
}

.status-badge.unpaid {
  background-color: rgba(248, 113, 113, 0.2);
  color: #f87171;
}

.status-badge.partial {
  background-color: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
}

/* Fee Table */
.fee-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1.5rem;
}

.fee-table th {
  background: var(--primary);
  color: white;
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
}

.fee-table td {
  padding: 12px 15px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.fee-table tr:nth-child(even) {
  background: rgba(255,255,255,0.03);
}

.fee-table tr:hover {
  background: rgba(214, 158, 46, 0.1);
}

/* Payment Receipt Modal */
.receipt-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 2000;
  overflow-y: auto;
  backdrop-filter: blur(5px);
}

.receipt-content {
  background: var(--glass);
  max-width: 800px;
  margin: 5% auto;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  position: relative;
}

.close-receipt {
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 1.5rem;
  color: var(--secondary);
  cursor: pointer;
  background: none;
  border: none;
}

.receipt-header {
  text-align: center;
  margin-bottom: 2rem;
}

.receipt-header img {
  height: 80px;
  margin-bottom: 1rem;
}

.receipt-header h2 {
  color: var(--secondary);
  margin-bottom: 0.5rem;
}

.receipt-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

.receipt-details div p {
  margin-bottom: 0.5rem;
}

.receipt-details div p span {
  font-weight: 600;
  color: var(--secondary);
}

.receipt-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 2rem;
}

.receipt-table th,
.receipt-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.receipt-table th {
  background: var(--primary);
  color: white;
}

.receipt-table tr:last-child td {
  border-bottom: none;
  font-weight: 600;
}

.receipt-footer {
  text-align: center;
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px dashed rgba(255,255,255,0.2);
}

.receipt-actions {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 2rem;
}

.receipt-actions button {
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.receipt-actions button:first-child {
  background: var(--secondary);
  color: #1a365d;
  border: none;
}

.receipt-actions button:last-child {
  background: transparent;
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
}

/* Responsive adjustments for fee management */
@media (max-width: 767px) {
  .fee-form {
    grid-template-columns: 1fr;
  }
  
  .fee-summary-cards {
    grid-template-columns: 1fr;
  }
  
  .receipt-details {
    grid-template-columns: 1fr;
  }
  
  .receipt-actions {
    flex-direction: column;
  }
  
  .receipt-actions button {
    width: 100%;
  }
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
}

::-webkit-scrollbar-thumb {
  background: var(--secondary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #e69c2a;
}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <img
        src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg"
        alt="Logo"
        class="header-logo"
      />
      <span>Teacher</span> Dashboard
    </div>
    <div class="header-controls">
      <button id="hamburgerBtn" class="hamburger-btn">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Side Menu -->
  <aside id="sideMenu">
    <h2><i class="fas fa-users"></i> Student Totals</h2>
    <div id="totalsDisplay">
      <p><strong>Overall:</strong> <span id="overallTotal">0</span></p>
      <ul id="formTotals"></ul>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Guidance Instructions -->
    <div id="guidance">
      <img src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" alt="Favicon" class="guidance-favicon" />
      <p>
        <strong>Instructions:</strong> Choose your class by selecting the Form and Stream from the dropdown menus. Then, click on a student card to view or enter marks. If you choose the wrong student, simply click "Cancel" to choose another.
      </p>
    </div>

    <!-- Fee Management Section -->
    <div class="fee-management-section">
      <h2><i class="fas fa-money-bill-wave"></i> Fee Management</h2>
      
      <div class="fee-tabs">
        <div class="fee-tab active" data-tab="fee-records">Fee Records</div>
        <div class="fee-tab" data-tab="fee-payment">Record Payment</div>
        <div class="fee-tab" data-tab="fee-reports">Reports</div>
      </div>
      
      <!-- Fee Records Tab -->
      <div class="fee-tab-content active" id="fee-records">
        <div class="fee-summary-cards">
          <div class="fee-summary-card paid">
            <h3><i class="fas fa-check-circle"></i> Paid Fees</h3>
            <p id="paid-count">0</p>
            <small>Students who have fully paid</small>
          </div>
          <div class="fee-summary-card unpaid">
            <h3><i class="fas fa-times-circle"></i> Unpaid Fees</h3>
            <p id="unpaid-count">0</p>
            <small>Students with unpaid fees</small>
          </div>
          <div class="fee-summary-card partial">
          	            <h3><i class="fas fa-exclamation-circle"></i> Partial Payments</h3>
            <p id="partial-count">0</p>
            <small>Students with partial payments</small>
          </div>
          <div class="fee-summary-card total">
            <h3><i class="fas fa-coins"></i> Total Collected</h3>
            <p id="total-collected">K0.00</p>
            <small>Total fees collected this term</small>
          </div>
        </div>

        <div class="filter-group">
          <div class="filter-row">
            <select id="feeFormFilter" class="filter-select">
              <option value="">All Forms</option>
              <option value="Form 1">Form 1</option>
              <option value="Form 2">Form 2</option>
              <option value="Form 3">Form 3</option>
              <option value="Form 4">Form 4</option>
              <option value="Form 5">Form 5</option>
              <option value="Form 6">Form 6</option>
            </select>
            <select id="feeStreamFilter" class="filter-select">
              <option value="">All Streams</option>
              <option value="Arts">Arts</option>
              <option value="Commercials">Commercials</option>
              <option value="Sciences">Sciences</option>
              <option value="G">G</option>
              <option value="W">W</option>
              <option value="Z">Z</option>
              <option value="E">E</option>
              <option value="U">U</option>
            </select>
            <select id="feeStatusFilter" class="filter-select">
              <option value="">All Statuses</option>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
              <option value="partial">Partial</option>
            </select>
            <button id="resetFilters" class="filter-btn">
              <i class="fas fa-sync-alt"></i> Reset
            </button>
          </div>
        </div>

        <table id="feeRecordsTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Student</th>
              <th>Form</th>
              <th>Stream</th>
              <th>Fee Amount</th>
              <th>Amount Paid</th>
              <th>Balance</th>
              <th>Status</th>
              <th>Payment Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Fee Payment Tab -->
      <div class="fee-tab-content" id="fee-payment">
        <form id="feePaymentForm" class="fee-form">
          <div class="fee-form-group">
            <label for="paymentStudent">Select Student</label>
            <select id="paymentStudent" required>
              <option value="">-- Select Student --</option>
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="fee-form-group">
            <label for="paymentTerm">Term</label>
            <select id="paymentTerm" required>
              <option value="">-- Select Term --</option>
              <option value="Term 1">Term 1</option>
              <option value="Term 2">Term 2</option>
              <option value="Term 3">Term 3</option>
            </select>
          </div>
          <div class="fee-form-group">
            <label for="paymentYear">Year</label>
            <input type="text" id="paymentYear" placeholder="Enter academic year (e.g. 2025)" required>
          </div>
          <div class="fee-form-group">
            <label for="feeAmount">Total Fee Amount (K)</label>
            <input type="number" id="feeAmount" placeholder="Enter total fee amount" required>
          </div>
          <div class="fee-form-group">
            <label for="amountPaid">Amount Paid (K)</label>
            <input type="number" id="amountPaid" placeholder="Enter amount paid" required>
          </div>
          <div class="fee-form-group">
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod" required>
              <option value="">-- Select Method --</option>
              <option value="Cash">Cash</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Mobile Money">Mobile Money</option>
              <option value="Cheque">Cheque</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="fee-form-group">
            <label for="receiptNumber">Receipt Number</label>
            <input type="text" id="receiptNumber" placeholder="Enter receipt number">
          </div>
          <div class="fee-form-group">
            <label for="paymentNotes">Notes</label>
            <textarea id="paymentNotes" placeholder="Any additional notes"></textarea>
          </div>
          <div class="fee-form-actions">
            <button type="submit"><i class="fas fa-save"></i> Record Payment</button>
            <button type="reset"><i class="fas fa-times"></i> Clear Form</button>
          </div>
        </form>
      </div>
      
      <!-- Fee Reports Tab -->
      <div class="fee-tab-content" id="fee-reports">
        <div class="report-filters">
          <div class="filter-row">
            <select id="reportFormFilter" class="filter-select">
              <option value="">All Forms</option>
              <option value="Form 1">Form 1</option>
              <option value="Form 2">Form 2</option>
              <option value="Form 3">Form 3</option>
              <option value="Form 4">Form 4</option>
              <option value="Form 5">Form 5</option>
              <option value="Form 6">Form 6</option>
            </select>
            <select id="reportTermFilter" class="filter-select">
              <option value="">All Terms</option>
              <option value="Term 1">Term 1</option>
              <option value="Term 2">Term 2</option>
              <option value="Term 3">Term 3</option>
            </select>
            <select id="reportYearFilter" class="filter-select">
              <option value="">All Years</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
            <button id="generateReport" class="report-btn">
              <i class="fas fa-file-export"></i> Generate Report
            </button>
          </div>
        </div>
        
        <div class="chart-container">
          <canvas id="feeTrendsChart"></canvas>
        </div>
        
        <div class="report-actions">
          <button class="pdf-btn" id="exportFeeReport">
            <i class="fas fa-file-pdf"></i> Export to PDF
          </button>
          <button class="excel-btn" id="exportFeeExcel">
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
        </div>
      </div>
    </div>

    <!-- Search Field -->
    <input
      type="text"
      id="searchStudent"
      placeholder="ðŸ” Search student by name..."
      onkeyup="filterStudents()"
    />

    <!-- Filter Section -->
    <div id="filterSection">
      <select id="formSelect" onchange="filterByForm()">
        <option value="">Select Form</option>
        <option value="Form 1">Form 1</option>
        <option value="Form 2">Form 2</option>
        <option value="Form 3">Form 3</option>
        <option value="Form 4">Form 4</option>
        <option value="Form 5">Form 5</option>
        <option value="Form 6">Form 6</option>
      </select>
      <select id="streamSelect" onchange="filterByStream()" style="display: none;">
        <option value="">Select Stream/Class</option>
      </select>
    </div>

    <!-- Marks Entry Form -->
    <form id="marksForm">
      <h2>Enter Marks for <span id="selectedStudent"></span></h2>
      <div class="form-group">
        <label>
          <input type="checkbox" id="feesPaid" checked /> Fees Paid for this term
        </label>
      </div>
      <div class="form-group" id="feesBalanceGroup" style="display: none;">
        <label for="feesBalance">Enter Fees Balance</label>
        <input type="number" id="feesBalance" placeholder="Enter fees balance" />
      </div>
      <div class="form-group">
        <label for="yearInput">Year</label>
        <input type="text" id="yearInput" placeholder="Enter academic year (e.g., 2025)" />
      </div>
      <div class="form-group">
        <label for="termInput">Term</label>
        <select id="termInput">
          <option value="">Select Term</option>
          <option value="Term 1">Term 1</option>
          <option value="Term 2">Term 2</option>
          <option value="Term 3">Term 3</option>
        </select>
      </div>
      <div class="form-group">
        <label for="teacherName">Class Teacher Name</label>
        <input type="text" id="teacherName" placeholder="Enter your name" />
      </div>
      <div class="form-group">
        <label for="teacherComments">Class Teachers Comments</label>
        <textarea id="teacherComments" placeholder="Enter comments"></textarea>
      </div>
      <div id="subjectFields"></div>
      <div class="form-actions">
        <button type="submit"><i class="fas fa-save"></i> Save Marks</button>
        <button type="button" onclick="cancelSelection()"><i class="fas fa-times"></i> Cancel</button>
      </div>
    </form>

    <!-- Report Card -->
    <div id="reportCard" class="report-card">
      <div class="report-header">
        <p>Name: <span id="reportName"></span></p>
        <p>Surname: <span id="reportSurname"></span></p>
        <p>Email: <span id="reportEmail"></span></p>
        <p>Year: <span id="reportYear"></span></p>
        <p>Term: <span id="reportTerm"></span></p>
      </div>
      <h3><i class="fas fa-file-alt"></i> Report Card</h3>
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>Marks</th>
            <th>Grade</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportCardBody"></tbody>
      </table>
      <button class="pdf-btn" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
    </div>

    <!-- Student List -->
    <h2><i class="fas fa-user-graduate"></i> Student List</h2>
    <div id="studentList" class="student-list">
      <!-- Dynamically populated student cards -->
    </div>
  </div>

  <!-- Payment Receipt Modal -->
  <div id="receiptModal" class="receipt-modal">
    <div class="receipt-content">
      <button class="close-receipt">&times;</button>
      <div class="receipt-header">
        <img src="https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg" alt="School Logo">
        <h2>St. Mary's High School</h2>
        <p>Official Fee Payment Receipt</p>
      </div>
      <div class="receipt-details">
        <div>
          <p><span>Receipt No:</span> <span id="receiptNoDisplay">SMHS-2025-001</span></p>
          <p><span>Date:</span> <span id="receiptDateDisplay">15/03/2025</span></p>
          <p><span>Student Name:</span> <span id="receiptStudentDisplay">John Doe</span></p>
          <p><span>Form:</span> <span id="receiptFormDisplay">Form 4</span></p>
          <p><span>Stream:</span> <span id="receiptStreamDisplay">Sciences</span></p>
        </div>
        <div>
          <p><span>Academic Year:</span> <span id="receiptYearDisplay">2025</span></p>
          <p><span>Term:</span> <span id="receiptTermDisplay">Term 1</span></p>
          <p><span>Payment Method:</span> <span id="receiptMethodDisplay">Bank Transfer</span></p>
          <p><span>Received By:</span> <span id="receiptReceivedBy">Mrs. Banda</span></p>
        </div>
      </div>
      <table class="receipt-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount (K)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Tuition Fees</td>
            <td id="receiptTuitionAmount">1,500.00</td>
          </tr>
          <tr>
            <td>Examination Fees</td>
            <td id="receiptExamAmount">300.00</td>
          </tr>
          <tr>
            <td>Other Fees</td>
            <td id="receiptOtherAmount">200.00</td>
          </tr>
          <tr>
            <td><strong>Total Amount</strong></td>
            <td><strong id="receiptTotalAmount">2,000.00</strong></td>
          </tr>
          <tr>
            <td><strong>Amount Paid</strong></td>
            <td><strong id="receiptPaidAmount">2,000.00</strong></td>
          </tr>
          <tr>
            <td><strong>Balance</strong></td>
            <td><strong id="receiptBalanceAmount">0.00</strong></td>
          </tr>
        </tbody>
      </table>
      <div class="receipt-footer">
        <p>Thank you for your payment. Please keep this receipt for your records.</p>
        <p><em>For any inquiries, contact the school office during working hours.</em></p>
      </div>
      <div class="receipt-actions">
        <button id="printReceipt"><i class="fas fa-print"></i> Print Receipt</button>
        <button id="closeReceipt"><i class="fas fa-times"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 St. Mary's High School. All rights reserved.</p>
    <div class="social-icons">
      <a href="#" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="#" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
      <a href="#" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
      <a href="#" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
    </div>
  </footer>

  <!-- Theme Toggle Button -->
  <button id="themeToggleButton" title="Toggle Dark/Light Mode">
    <i class="fas fa-moon"></i>
  </button>

  <!-- jQuery and DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <!-- Firebase and App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      doc,
      setDoc,
      updateDoc,
      arrayUnion,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAR9J2Wz7Eu8dXRzDG8JNHcymLCUQUPJRo",
      authDomain: "deee-9ab53.firebaseapp.com",
      projectId: "deee-9ab53",
      storageBucket: "deee-9ab53.appspot.com",
      messagingSenderId: "399732664479",
      appId: "1:399732664479:web:b84ac30e8266cc51761aaa",
      measurementId: "G-524ZPBX42B"
    };

    // Initialize Firebase
    const appFirebase = initializeApp(firebaseConfig);
    const db = getFirestore(appFirebase);

    // Global variables
    let allStudents = [];
    let feeRecords = [];
    let feeTable;
    let feeTrendsChart;
    const studentList = document.getElementById("studentList");
    const marksForm = document.getElementById("marksForm");
    const reportCard = document.getElementById("reportCard");
    const reportCardBody = document.getElementById("reportCardBody");
    let performanceChart;

    // Initialize DataTable for fee records
    function initializeFeeTable() {
      feeTable = $('#feeRecordsTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
          'copy', 'csv', 'excel', 'pdf', 'print'
        ],
        responsive: true,
        pageLength: 10,
        order: [[1, 'asc'], [2, 'asc']],
        columnDefs: [
          { targets: [3,4,5], render: $.fn.dataTable.render.number(',', '.', 2, 'K') },
          { 
            targets: 6,
            render: function(data, type, row) {
              let badgeClass = '';
              if (data === 'paid') badgeClass = 'paid';
              else if (data === 'unpaid') badgeClass = 'unpaid';
              else badgeClass = 'partial';
              return `<span class="status-badge ${badgeClass}">${data.charAt(0).toUpperCase() + data.slice(1)}</span>`;
            }
          },
          {
            targets: -1,
            orderable: false,
            render: function(data, type, row) {
              return `
                <button class="edit-btn" onclick="editFeeRecord('${row[8]}')"><i class="fas fa-edit"></i></button>
                <button class="delete-btn" onclick="deleteFeeRecord('${row[8]}')"><i class="fas fa-trash"></i></button>
                <button class="view-btn" onclick="viewReceipt('${row[8]}')"><i class="fas fa-receipt"></i></button>
              `;
            }
          }
        ]
      });
    }

    // Fetch students and fee records
    async function fetchStudents() {
      try {
        const querySnapshot = await getDocs(collection(db, "students"));
        let students = [];
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          data.id = docSnap.id;
          students.push(data);
        });
        // Sort by surname
        students.sort((a, b) => (a.surname || "").localeCompare(b.surname || ""));
        allStudents = students;
        displayStudents(allStudents);
        updateSideMenu();
        populateStudentDropdown();
        
        // Now fetch fee records
        await fetchFeeRecords();
      } catch (err) {
        console.error("Error fetching students:", err);
        alert("Error fetching students. Please try again later.");
      }
    }

    // Fetch fee records
    async function fetchFeeRecords() {
      try {
        const querySnapshot = await getDocs(collection(db, "feePayments"));
        feeRecords = [];
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          data.id = docSnap.id;
          feeRecords.push(data);
        });
        updateFeeTable();
        updateFeeSummaryCards();
      } catch (err) {
        console.error("Error fetching fee records:", err);
        alert("Error fetching fee records. Please try again later.");
      }
    }

    // Update fee records table
    function updateFeeTable() {
      if (!feeTable) initializeFeeTable();
      
      feeTable.clear();
      
      feeRecords.forEach(record => {
        const student = allStudents.find(s => s.id === record.studentId);
        if (!student) return;
        
        const status = getPaymentStatus(record);
        const balance = record.feeAmount - record.amountPaid;
        
        feeTable.row.add([
          `${student.firstname} ${student.surname}`,
          student.form || '',
          student.stream || '',
          record.feeAmount,
          record.amountPaid,
          balance > 0 ? balance : 0,
          status,
          record.paymentDate || '',
          record.id
        ]);
      });
      
      feeTable.draw();
    }

    // Get payment status
    function getPaymentStatus(record) {
      if (record.amountPaid >= record.feeAmount) return 'paid';
      if (record.amountPaid <= 0) return 'unpaid';
      return 'partial';
    }

    // Update fee summary cards
    function updateFeeSummaryCards() {
      let paidCount = 0;
      let unpaidCount = 0;
      let partialCount = 0;
      let totalCollected = 0;
      
      feeRecords.forEach(record => {
        const status = getPaymentStatus(record);
        if (status === 'paid') {
          paidCount++;
          totalCollected += record.amountPaid;
        } else if (status === 'unpaid') {
          unpaidCount++;
        } else {
          partialCount++;
          totalCollected += record.amountPaid;
        }
      });
      
      document.getElementById('paid-count').textContent = paidCount;
      document.getElementById('unpaid-count').textContent = unpaidCount;
      document.getElementById('partial-count').textContent = partialCount;
      document.getElementById('total-collected').textContent = `K${totalCollected.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;}
      
    // Populate student dropdown for fee payment
    function populateStudentDropdown() {
      const dropdown = document.getElementById('paymentStudent');
      dropdown.innerHTML = '<option value="">-- Select Student --</option>';
      
      allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.firstname} ${student.surname} (${student.form || ''} ${student.stream || ''})`;
        dropdown.appendChild(option);
      });
    }

    // Handle fee payment form submission
    document.getElementById('feePaymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const studentId = document.getElementById('paymentStudent').value;
      const term = document.getElementById('paymentTerm').value;
      const year = document.getElementById('paymentYear').value;
      const feeAmount = parseFloat(document.getElementById('feeAmount').value);
      const amountPaid = parseFloat(document.getElementById('amountPaid').value);
      const paymentMethod = document.getElementById('paymentMethod').value;
      const receiptNumber = document.getElementById('receiptNumber').value;
      const paymentNotes = document.getElementById('paymentNotes').value;
      
      if (!studentId || !term || !year || isNaN(feeAmount) || isNaN(amountPaid) || !paymentMethod) {
        alert('Please fill in all required fields');
        return;
      }
      
      if (amountPaid > feeAmount) {
        alert('Amount paid cannot be greater than fee amount');
        return;
      }
      
      try {
        // Add fee payment record
        const paymentData = {
          studentId,
          term,
          year,
          feeAmount,
          amountPaid,
          paymentMethod,
          receiptNumber: receiptNumber || null,
          paymentNotes: paymentNotes || null,
          paymentDate: new Date().toISOString().split('T')[0],
          recordedAt: serverTimestamp()
        };
        
        // Add to fee payments collection
        const docRef = await addDoc(collection(db, "feePayments"), paymentData);
        
        // Update student document with fee status
        const studentRef = doc(db, "students", studentId);
        await updateDoc(studentRef, {
          feesPaid: amountPaid >= feeAmount,
          feesBalance: feeAmount - amountPaid,
          lastFeePayment: paymentData
        });
        
        alert('Fee payment recorded successfully!');
        this.reset();
        await fetchFeeRecords();
        showReceipt(docRef.id);
      } catch (err) {
        console.error("Error recording fee payment:", err);
        alert("Error recording fee payment. Please try again.");
      }
    });

    // Show payment receipt
    function showReceipt(paymentId) {
      const payment = feeRecords.find(r => r.id === paymentId);
      if (!payment) return;
      
      const student = allStudents.find(s => s.id === payment.studentId);
      if (!student) return;
      
      // Populate receipt data
      document.getElementById('receiptNoDisplay').textContent = payment.receiptNumber || `SMHS-${new Date().getFullYear()}-${payment.id.slice(0, 4).toUpperCase()}`;
      document.getElementById('receiptDateDisplay').textContent = new Date().toLocaleDateString();
      document.getElementById('receiptStudentDisplay').textContent = `${student.firstname} ${student.surname}`;
      document.getElementById('receiptFormDisplay').textContent = student.form || '';
      document.getElementById('receiptStreamDisplay').textContent = student.stream || '';
      document.getElementById('receiptYearDisplay').textContent = payment.year;
      document.getElementById('receiptTermDisplay').textContent = payment.term;
      document.getElementById('receiptMethodDisplay').textContent = payment.paymentMethod;
      document.getElementById('receiptReceivedBy').textContent = document.getElementById('teacherName').value || 'School Admin';
      
      // For demo purposes - in a real app these would come from the database
      document.getElementById('receiptTuitionAmount').textContent = (payment.feeAmount * 0.75).toFixed(2);
      document.getElementById('receiptExamAmount').textContent = (payment.feeAmount * 0.15).toFixed(2);
      document.getElementById('receiptOtherAmount').textContent = (payment.feeAmount * 0.10).toFixed(2);
      document.getElementById('receiptTotalAmount').textContent = payment.feeAmount.toFixed(2);
      document.getElementById('receiptPaidAmount').textContent = payment.amountPaid.toFixed(2);
      document.getElementById('receiptBalanceAmount').textContent = Math.max(0, payment.feeAmount - payment.amountPaid).toFixed(2);
      
      // Show modal
      document.getElementById('receiptModal').style.display = 'block';
    }

    // Close receipt modal
    document.querySelector('.close-receipt').addEventListener('click', function() {
      document.getElementById('receiptModal').style.display = 'none';
    });

    document.getElementById('closeReceipt').addEventListener('click', function() {
      document.getElementById('receiptModal').style.display = 'none';
    });

    // Print receipt
    document.getElementById('printReceipt').addEventListener('click', function() {
      window.print();
    });

    // Filter fee records
    document.getElementById('feeFormFilter').addEventListener('change', filterFeeRecords);
    document.getElementById('feeStreamFilter').addEventListener('change', filterFeeRecords);
    document.getElementById('feeStatusFilter').addEventListener('change', filterFeeRecords);
    document.getElementById('resetFilters').addEventListener('click', resetFeeFilters);

    function filterFeeRecords() {
      const formFilter = document.getElementById('feeFormFilter').value;
      const streamFilter = document.getElementById('feeStreamFilter').value;
      const statusFilter = document.getElementById('feeStatusFilter').value;
      
      feeTable.search('').columns().search('').draw();
      
      if (formFilter) {
        feeTable.column(1).search(formFilter).draw();
      }
      
      if (streamFilter) {
        feeTable.column(2).search(streamFilter).draw();
      }
      
      if (statusFilter) {
        feeTable.column(6).search(statusFilter).draw();
      }
    }

    function resetFeeFilters() {
      document.getElementById('feeFormFilter').value = '';
      document.getElementById('feeStreamFilter').value = '';
      document.getElementById('feeStatusFilter').value = '';
      feeTable.search('').columns().search('').draw();
    }

    // Initialize fee trends chart
    function initFeeTrendsChart() {
      const ctx = document.getElementById('feeTrendsChart').getContext('2d');
      feeTrendsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Term 1', 'Term 2', 'Term 3'],
          datasets: [
            {
              label: 'Total Collected (K)',
              data: [0, 0, 0],
              backgroundColor: 'rgba(214, 158, 46, 0.7)',
              borderColor: 'rgba(214, 158, 46, 1)',
              borderWidth: 1
            },
            {
              label: 'Outstanding (K)',
              data: [0, 0, 0],
              backgroundColor: 'rgba(248, 113, 113, 0.7)',
              borderColor: 'rgba(248, 113, 113, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'K' + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': K' + context.raw.toLocaleString();
                }
              }
            }
          }
        }
      });
      
      updateFeeTrendsChart();
    }

    // Update fee trends chart
    function updateFeeTrendsChart() {
      if (!feeTrendsChart) initFeeTrendsChart();
      
      const currentYear = new Date().getFullYear();
      const termData = {
        'Term 1': { collected: 0, outstanding: 0 },
        'Term 2': { collected: 0, outstanding: 0 },
        'Term 3': { collected: 0, outstanding: 0 }
      };
      
      feeRecords.forEach(record => {
        if (record.year == currentYear && termData[record.term]) {
          termData[record.term].collected += record.amountPaid;
          termData[record.term].outstanding += Math.max(0, record.feeAmount - record.amountPaid);
        }
      });
      
      feeTrendsChart.data.datasets[0].data = [
        termData['Term 1'].collected,
        termData['Term 2'].collected,
        termData['Term 3'].collected
      ];
      
      feeTrendsChart.data.datasets[1].data = [
        termData['Term 1'].outstanding,
        termData['Term 2'].outstanding,
        termData['Term 3'].outstanding
      ];
      
      feeTrendsChart.update();
    }

    // Tab switching
    document.querySelectorAll('.fee-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.fee-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.fee-tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById(this.dataset.tab).classList.add('active');
      });
    });

    // Export fee report
    document.getElementById('exportFeeReport').addEventListener('click', exportFeeReportPDF);
    document.getElementById('exportFeeExcel').addEventListener('click', exportFeeReportExcel);

    function exportFeeReportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add school logo
      doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
      
      // School header
      doc.setFontSize(18);
      doc.setTextColor(26, 54, 93);
      doc.text('St. Mary\'s High School', 50, 20);
      doc.setFontSize(14);
      doc.text('Fee Payment Report', 50, 28);
      
      // Report filters
      const formFilter = document.getElementById('reportFormFilter').value || 'All Forms';
      const termFilter = document.getElementById('reportTermFilter').value || 'All Terms';
      const yearFilter = document.getElementById('reportYearFilter').value || 'All Years';
      
      doc.setFontSize(12);
      doc.text(`Form: ${formFilter}`, 14, 45);
      doc.text(`Term: ${termFilter}`, 14, 55);
      doc.text(`Year: ${yearFilter}`, 14, 65);
      
      // Summary statistics
      doc.setFontSize(14);
      doc.setTextColor(26, 54, 93);
      doc.text('Summary Statistics', 14, 80);
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Total Paid Students: ${document.getElementById('paid-count').textContent}`, 14, 90);
      doc.text(`Total Unpaid Students: ${document.getElementById('unpaid-count').textContent}`, 14, 100);
      doc.text(`Total Partial Payments: ${document.getElementById('partial-count').textContent}`, 14, 110);
      doc.text(`Total Collected: ${document.getElementById('total-collected').textContent}`, 14, 120);
      
      // Fee records table
      doc.setFontSize(14);
      doc.setTextColor(26, 54, 93);
      doc.text('Fee Payment Details', 14, 140);
      
      const headers = [['Student', 'Form', 'Stream', 'Fee Amount', 'Amount Paid', 'Balance', 'Status']];
      const data = [];
      
      feeRecords.forEach(record => {
        const student = allStudents.find(s => s.id === record.studentId);
        if (!student) return;
        
        // Apply filters
        if (formFilter !== 'All Forms' && student.form !== formFilter) return;
        if (termFilter !== 'All Terms' && record.term !== termFilter) return;
        if (yearFilter !== 'All Years' && record.year !== yearFilter) return;
        
        const status = getPaymentStatus(record);
        const balance = record.feeAmount - record.amountPaid;
        
        data.push([
          `${student.firstname} ${student.surname}`,
          student.form || '',
          student.stream || '',
                    `K${record.feeAmount.toFixed(2)}`,
          `K${record.amountPaid.toFixed(2)}`,
          `K${Math.max(0, balance).toFixed(2)}`,
          status.charAt(0).toUpperCase() + status.slice(1)
        ]);
      });

      doc.autoTable({
        head: headers,
        body: data,
        startY: 150,
        headStyles: {
          fillColor: [26, 54, 93],
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        styles: {
          cellPadding: 5,
          fontSize: 10
        }
      });

      // Footer
      const date = new Date().toLocaleDateString();
      doc.setFontSize(10);
      doc.text(`Generated on: ${date}`, 14, doc.lastAutoTable.finalY + 15);
      doc.text('Â© 2025 St. Mary\'s High School', 160, doc.lastAutoTable.finalY + 15);

      doc.save(`fee_report_${formFilter}_${termFilter}_${yearFilter}.pdf`);
    }

    function exportFeeReportExcel() {
      // Create a workbook
      const wb = XLSX.utils.book_new();
      
      // Prepare data
      const headers = ['Student', 'Form', 'Stream', 'Fee Amount (K)', 'Amount Paid (K)', 'Balance (K)', 'Status', 'Payment Date', 'Method'];
      const data = [headers];
      
      feeRecords.forEach(record => {
        const student = allStudents.find(s => s.id === record.studentId);
        if (!student) return;
        
        const status = getPaymentStatus(record);
        const balance = record.feeAmount - record.amountPaid;
        
        data.push([
          `${student.firstname} ${student.surname}`,
          student.form || '',
          student.stream || '',
          record.feeAmount,
          record.amountPaid,
          Math.max(0, balance),
          status.charAt(0).toUpperCase() + status.slice(1),
          record.paymentDate || '',
          record.paymentMethod
        ]);
      });
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "Fee Payments");
      
      // Generate and download Excel file
      XLSX.writeFile(wb, `fee_payments_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // Edit fee record
    window.editFeeRecord = async function(paymentId) {
      const payment = feeRecords.find(r => r.id === paymentId);
      if (!payment) return;
      
      const student = allStudents.find(s => s.id === payment.studentId);
      if (!student) return;
      
      // Switch to payment tab
      document.querySelectorAll('.fee-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.fee-tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.fee-tab[data-tab="fee-payment"]').classList.add('active');
      document.getElementById('fee-payment').classList.add('active');
      
      // Populate form
      document.getElementById('paymentStudent').value = payment.studentId;
      document.getElementById('paymentTerm').value = payment.term;
      document.getElementById('paymentYear').value = payment.year;
      document.getElementById('feeAmount').value = payment.feeAmount;
      document.getElementById('amountPaid').value = payment.amountPaid;
      document.getElementById('paymentMethod').value = payment.paymentMethod;
      document.getElementById('receiptNumber').value = payment.receiptNumber || '';
      document.getElementById('paymentNotes').value = payment.paymentNotes || '';
      
      // Scroll to form
      document.getElementById('feePaymentForm').scrollIntoView({ behavior: 'smooth' });
    };

    // Delete fee record
    window.deleteFeeRecord = async function(paymentId) {
      if (!confirm('Are you sure you want to delete this fee record? This action cannot be undone.')) return;
      
      try {
        // In a real app, you would delete from Firebase here
        // await deleteDoc(doc(db, "feePayments", paymentId));
        
        // For demo purposes, just remove from local array
        feeRecords = feeRecords.filter(r => r.id !== paymentId);
        updateFeeTable();
        updateFeeSummaryCards();
        updateFeeTrendsChart();
        
        alert('Fee record deleted successfully!');
      } catch (err) {
        console.error("Error deleting fee record:", err);
        alert("Error deleting fee record. Please try again.");
      }
    };

    // View receipt
    window.viewReceipt = function(paymentId) {
      showReceipt(paymentId);
    };

    // Display students as cards
    function displayStudents(students) {
      studentList.innerHTML = "";
      if (!students.length) {
        studentList.innerHTML = `<div class="notification" style="padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
          <i class="fas fa-info-circle"></i> No students found matching your criteria
        </div>`;
        return;
      }
      students.forEach((s) => {
        const card = document.createElement("div");
        card.className = "student-card";
        card.innerHTML = `
          <h3>${s.firstname || ""} ${s.surname || ""}</h3>
          <p>${s.email || ""}</p>
          <p><small>${s.form || "No form"} ${s.stream ? "â€¢ " + s.stream : ""}</small></p>
          ${s.feesPaid !== undefined ? 
            `<div class="fee-status ${s.feesPaid ? 'paid' : (s.feesBalance && s.feesBalance < s.feeAmount ? 'partial' : 'unpaid')}">
              ${s.feesPaid ? 'Fully Paid' : (s.feesBalance && s.feesBalance < s.feeAmount ? 'Partial Payment' : 'Unpaid')}
            </div>` : ''}
        `;
        card.addEventListener("click", () => openMarksForm(s));
        studentList.appendChild(card);
      });
    }

    // Update side menu totals
    function updateSideMenu() {
      const overall = allStudents.length;
      document.getElementById("overallTotal").textContent = overall;

      // Group by form -> streams
      const formsCount = {};
      allStudents.forEach((st) => {
        const f = st.form || "Unknown";
        const str = st.stream || "Not set";
        if (!formsCount[f]) {
          formsCount[f] = { total: 0, streams: {} };
        }
        formsCount[f].total++;
        if (!formsCount[f].streams[str]) {
          formsCount[f].streams[str] = 0;
        }
        formsCount[f].streams[str]++;
      });

      // Sort forms
      const formTotalsEl = document.getElementById("formTotals");
      formTotalsEl.innerHTML = "";
      const sortedForms = Object.keys(formsCount).sort((a, b) => {
        const numA = parseInt(a.replace("Form ", "")) || 0;
        const numB = parseInt(b.replace("Form ", "")) || 0;
        return numA - numB;
      });

      sortedForms.forEach((f) => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${f}:</strong> ${formsCount[f].total}`;
        const streamsUl = document.createElement("ul");
        Object.keys(formsCount[f].streams).forEach((st) => {
          const stLi = document.createElement("li");
          stLi.textContent = `${st}: ${formsCount[f].streams[st]}`;
          streamsUl.appendChild(stLi);
        });
        li.appendChild(streamsUl);
        formTotalsEl.appendChild(li);
      });
    }

    // Filter logic
    window.filterStudents = () => {
      const search = document.getElementById("searchStudent").value.toLowerCase();
      document.querySelectorAll(".student-card").forEach((card) => {
        card.style.display = card.textContent.toLowerCase().includes(search) ? "" : "none";
      });
    };
    window.filterByForm = () => {
      const formVal = document.getElementById("formSelect").value;
      const streamSel = document.getElementById("streamSelect");
      let filtered = [...allStudents];
      if (!formVal) {
        streamSel.style.display = "none";
        streamSel.innerHTML = `<option value="">Select Stream/Class</option>`;
        displayStudents(filtered);
        return;
      }
      streamSel.style.display = "inline-block";
      if (formVal === "Form 5" || formVal === "Form 6") {
        streamSel.innerHTML = `<option value="">Select Stream/Class</option>
          <option value="Arts">Arts</option>
          <option value="Commercials">Commercials</option>
          <option value="Sciences">Sciences</option>`;
      } else {
        streamSel.innerHTML = `<option value="">Select Stream/Class</option>
          <option value="G">G</option>
          <option value="W">W</option>
          <option value="Z">Z</option>
          <option value="E">E</option>
          <option value="U">U</option>`;
      }
      filtered = filtered.filter((s) => s.form === formVal);
      const selectedStream = streamSel.value;
      if (selectedStream) {
        filtered = filtered.filter((s) => s.stream === selectedStream);
      }
      displayStudents(filtered);
    };
    window.filterByStream = () => {
      const formVal = document.getElementById("formSelect").value;
      const streamVal = document.getElementById("streamSelect").value;
      let filtered = [...allStudents];
      if (formVal) {
        filtered = filtered.filter((s) => s.form === formVal);
      }
      if (streamVal) {
        filtered = filtered.filter((s) => s.stream === streamVal);
      }
      displayStudents(filtered);
    };

    // Open marks form
    window.openMarksForm = (student) => {
      document.getElementById("selectedStudent").textContent = `${student.firstname || ""} ${student.surname || ""}`;
      marksForm.style.display = "block";
      marksForm.dataset.studentId = student.id;
      document.getElementById("feesPaid").checked = (student.feesPaid !== undefined) ? student.feesPaid : true;
      document.getElementById("feesBalance").value = student.feesBalance || "";
      if(student.feesPaid === false) {
        document.getElementById("feesBalanceGroup").style.display = "block";
      } else {
        document.getElementById("feesBalanceGroup").style.display = "none";
      }
      document.getElementById("yearInput").value = student.year || "";
      document.getElementById("termInput").value = student.term || "";
      document.getElementById("teacherName").value = student.teacherName || "";
      document.getElementById("teacherComments").value = student.teacherComments || "";
      const subjectFields = document.getElementById("subjectFields");
      subjectFields.innerHTML = "";
      const subs = student.marks || {};
      const keys = Object.keys(subs);
      for (let i = 0; i < 10; i++) {
        const subName = keys[i] || "";
        const marksVal = keys[i] ? subs[keys[i]].marks : "";
        const gradeVal = keys[i] ? subs[keys[i]].grade : "";
        subjectFields.innerHTML += `
          <div class="form-group">
            <label>Subject ${i + 1}</label>
            <input type="text" id="subject${i}" value="${subName}" placeholder="Enter subject name" />
            <input type="number" id="marks${i}" value="${marksVal}" placeholder="Enter marks" oninput="updateGrade(${i})"/>
            <select id="grade${i}">
              <option value="A" ${gradeVal === "A" ? "selected" : ""}>A (90-100)</option>
              <option value="B" ${gradeVal === "B" ? "selected" : ""}>B (80-89)</option>
              <option value="C" ${gradeVal === "C" ? "selected" : ""}>C (70-79)</option>
              <option value="D" ${gradeVal === "D" ? "selected" : ""}>D (60-69)</option>
              <option value="F" ${gradeVal === "F" ? "selected" : ""}>F (Below 60)</option>
            </select>
          </div>
        `;
      }
    };

    // Toggle fees balance input based on feesPaid checkbox
    document.getElementById("feesPaid").addEventListener("change", function() {
      if(this.checked) {
        document.getElementById("feesBalanceGroup").style.display = "none";
      } else {
        document.getElementById("feesBalanceGroup").style.display = "block";
      }
    });

    // Auto-grade
    window.updateGrade = (i) => {
      const marksInput = document.getElementById(`marks${i}`);
      const gradeSelect = document.getElementById(`grade${i}`);
      const val = Number(marksInput.value);
      let grade = "F";
      if (!isNaN(val)) {
        if (val >= 90) grade = "A";
        else if (val >= 80) grade = "B";
        else if (val >= 70) grade = "C";
        else if (val >= 60) grade = "D";
      }
      gradeSelect.value = grade;
    };

    // Save marks
    marksForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const studentId = marksForm.dataset.studentId;
      let newMarks = {};
      for (let i = 0; i < 10; i++) {
        const sub = document.getElementById(`subject${i}`).value.trim();
        const m = document.getElementById(`marks${i}`).value;
        const g = document.getElementById(`grade${i}`).value;
        if (sub && m) {
          newMarks[sub] = { marks: Number(m), grade: g };
        }
      }
      const yearVal = document.getElementById("yearInput").value.trim();
      const termVal = document.getElementById("termInput").value;
      const feesPaid = document.getElementById("feesPaid").checked;
      const feesBalance = document.getElementById("feesBalance").value;
      const teacherName = document.getElementById("teacherName").value.trim();
      const teacherComments = document.getElementById("teacherComments").value.trim();
      try {
        await setDoc(doc(db, "students", studentId), {
          marks: newMarks,
          year: yearVal,
          term: termVal,
          feesPaid: feesPaid,
          feesBalance: feesPaid ? 0 : Number(feesBalance),
          teacherName: teacherName,
          teacherComments: teacherComments
        }, { merge: true });
        alert("Marks saved successfully!");
        marksForm.reset();
        marksForm.style.display = "none";
        displayReportCard(studentId);
      } catch (err) {
        console.error("Error saving marks:", err);
        alert("Error saving marks. Please try again.");
      }
    });

    // Display report card
    async function displayReportCard(studentId) {
      try {
        const snap = await getDoc(doc(db, "students", studentId));
        if (snap.exists()) {
          const data = snap.data();
          const { name, surname } = extractNameSurname(data.email || "");
          document.getElementById("reportName").textContent = name;
          document.getElementById("reportSurname").textContent = surname;
          document.getElementById("reportEmail").textContent = data.email || "";
          document.getElementById("reportYear").textContent = data.year || "";
          document.getElementById("reportTerm").textContent = data.term || "";
          if (data.marks) {
            reportCard.style.display = "block";
            reportCardBody.innerHTML = "";
            let total = 0, count = 0;
            for (const [subj, info] of Object.entries(data.marks)) {
              reportCardBody.innerHTML += `
                <tr>
                  <td>${subj}</td>
                  <td>${info.marks}</td>
                  <td>${info.grade}</td>
                  <td>
                    <button class="edit-btn" onclick="editSubject('${studentId}', '${subj}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="delete-btn" onclick="deleteSubject('${studentId}', '${subj}')"><i class="fas fa-trash"></i> Delete</button>
                  </td>
                </tr>
              `;
              total += info.marks;
              count++;
            }
            const avg = count ? (total / count).toFixed(2) : 0;
            reportCardBody.innerHTML += `
              <tr><td colspan="4" style="font-weight: bold; background: rgba(214, 158, 46, 0.1);">Average Marks: ${avg}</td></tr>
            `;
            updateChart(data.marks);
          } else {
            reportCard.style.display = "none";
          }
        }
      } catch (err) {
        console.error("Error displaying report card:", err);
        alert("Error displaying report card. Please try again.");
      }
    }

    // Update chart
    function updateChart(marksData) {
      const ctx = document.getElementById("performanceChart").getContext("2d");
      const subs = Object.keys(marksData);
      const vals = subs.map((sub) => marksData[sub].marks);
      if (performanceChart) {
        performanceChart.destroy();
      }
      performanceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: subs,
          datasets: [
            {
              label: "Marks",
              data: vals,
              backgroundColor: "rgba(214, 158, 46, 0.5)",
              borderColor: "rgba(214, 158, 46, 1)",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { 
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed.y + '%';
                               }
              }
            }
          }
        }
      });
    }

    // Delete subject
    window.deleteSubject = async (studentId, subj) => {
      if (!confirm(`Are you sure you want to delete ${subj}? This action cannot be undone.`)) return;
      try {
        const snap = await getDoc(doc(db, "students", studentId));
        if (snap.exists()) {
          const data = snap.data();
          if (data.marks && data.marks[subj]) {
            delete data.marks[subj];
            await setDoc(doc(db, "students", studentId), {
              marks: data.marks
            }, { merge: true });
            alert(`${subj} deleted successfully!`);
            displayReportCard(studentId);
          }
        }
      } catch (err) {
        console.error("Error deleting subject:", err);
        alert("Error deleting subject. Please try again.");
      }
    };

    // Edit subject
    window.editSubject = async (studentId, subj) => {
      try {
        const snap = await getDoc(doc(db, "students", studentId));
        if (snap.exists()) {
          const data = snap.data();
          data.id = studentId;
          openMarksForm(data);
          setTimeout(() => {
            for (let i = 0; i < 10; i++) {
              const si = document.getElementById(`subject${i}`);
              if (si && si.value === subj) {
                si.focus();
                si.style.border = "2px solid var(--secondary)";
                setTimeout(() => (si.style.border = ""), 2000);
                break;
              }
            }
          }, 100);
        }
      } catch (err) {
        console.error("Error editing subject:", err);
        alert("Error editing subject. Please try again.");
      }
    };

    // Export to PDF
    window.exportPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("reportName").textContent;
      const surname = document.getElementById("reportSurname").textContent;
      const email = document.getElementById("reportEmail").textContent;
      const year = document.getElementById("reportYear").textContent;
      const term = document.getElementById("reportTerm").textContent;
      
      // Add school logo
      doc.addImage('https://i.postimg.cc/mZ81jqGW/In-Shot-20250227-051117557.jpg', 'JPEG', 10, 10, 30, 30);
      
      // School header
      doc.setFontSize(18);
      doc.setTextColor(26, 54, 93);
      doc.text('St. Mary\'s High School', 50, 20);
      doc.setFontSize(12);
      doc.text('Academic Report Card', 50, 28);
      
      // Student info
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text(`Name: ${name} ${surname}`, 14, 50);
      doc.text(`Email: ${email}`, 14, 60);
      doc.text(`Academic Year: ${year} â€¢ Term: ${term}`, 14, 70);
      
      // Table data
      let rows = [];
      document.querySelectorAll("#reportCardBody tr").forEach((tr) => {
        const cells = [...tr.querySelectorAll("td")].map((td) => td.textContent);
        if (cells.length === 4) { // Skip the average row
          rows.push(cells);
        }
      });
      
      // Add table
      doc.autoTable({
        head: [["Subject", "Marks", "Grade", "Actions"]],
        body: rows,
        startY: 80,
        headStyles: {
          fillColor: [26, 54, 93],
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        styles: {
          cellPadding: 5,
          fontSize: 10
        }
      });
      
      // Footer
      const date = new Date().toLocaleDateString();
      doc.setFontSize(10);
      doc.text(`Generated on: ${date}`, 14, doc.lastAutoTable.finalY + 15);
      doc.text('Â© 2025 St. Mary\'s High School', 160, doc.lastAutoTable.finalY + 15);
      
      doc.save(`${name}_${surname}_report_card.pdf`);
    };

    // Cancel button functionality
    window.cancelSelection = () => {
      marksForm.reset();
      marksForm.style.display = "none";
    };

    // Hamburger toggle
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const sideMenu = document.getElementById("sideMenu");
    hamburgerBtn.addEventListener("click", () => {
      sideMenu.classList.toggle("shown");
    });

    // Theme toggle
    const themeToggleButton = document.getElementById("themeToggleButton");
    themeToggleButton.addEventListener("click", () => {
      if (document.body.getAttribute("data-theme") === "light") {
        document.body.removeAttribute("data-theme");
        themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem("theme", "dark");
      } else {
        document.body.setAttribute("data-theme", "light");
        themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem("theme", "light");
      }
    });

    // Check for saved theme preference
    if (localStorage.getItem("theme") === "light") {
      document.body.setAttribute("data-theme", "light");
      themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
    }

    // Utility function to extract name and surname from email
    function extractNameSurname(email) {
      const parts = email.split("@")[0].split(".");
      return {
        name: parts[0] ? parts[0].charAt(0).toUpperCase() + parts[0].slice(1) : "",
        surname: parts[1] ? parts[1].charAt(0).toUpperCase() + parts[1].slice(1) : ""
      };
    }

    // Load
    fetchStudents();
  </script>
</body>
</html>
